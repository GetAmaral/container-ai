==============================================================================
FIX - DETEC√á√ÉO DE CONFLITO DE HOR√ÅRIO (CONSOLIDADA)
==============================================================================

PROBLEMA:
---------
Quando o usu√°rio cria m√∫ltiplos eventos de uma vez (ex: "Crie reuni√£o √†s 14h,
consulta √†s 14h e almo√ßo √†s 14h"), o sistema antigo verificava conflitos
DENTRO do webhook de cria√ß√£o de cada evento individual. Resultado:

  Evento 1 ‚Üí webhook ‚Üí cria ‚Üí sem conflito
  Evento 2 ‚Üí webhook ‚Üí cria ‚Üí AVISA conflito com evento 1 ‚ö†Ô∏è
  Evento 3 ‚Üí webhook ‚Üí cria ‚Üí AVISA conflito com evento 1 e 2 ‚ö†Ô∏è‚ö†Ô∏è

O usu√°rio recebia m√∫ltiplas mensagens de aviso repetidas, uma para cada
evento do batch. Imposs√≠vel distinguir conflitos reais (com eventos
pr√©-existentes) de conflitos entre os pr√≥prios eventos do batch.


SOLU√á√ÉO:
--------
Mover a detec√ß√£o de conflito para DEPOIS de todos os eventos serem criados,
no workflow principal (caller), e remover a verifica√ß√£o de dentro do webhook.

  Evento 1 ‚Üí webhook ‚Üí cria ‚úÖ
  Evento 2 ‚Üí webhook ‚Üí cria ‚úÖ
  Evento 3 ‚Üí webhook ‚Üí cria ‚úÖ
  [Todos criados] ‚Üí Verifica conflitos (exclui batch) ‚Üí Avisa UMA VEZ ‚ö†Ô∏è


==============================================================================
ARQUIVOS CRIADOS
==============================================================================

1. fix-conflito-horario-workflow.json
   ‚Üí Webhook Calendar-Creator ATUALIZADO (sem o node Get many rows1)

2. fix-conflito-horario-nodes-principais.json
   ‚Üí Nodes do workflow principal com a detec√ß√£o de conflito consolidada

3. fix-conflito-horario-passo-a-passo.txt (este arquivo)


==============================================================================
PASSO A PASSO - IMPLEMENTA√á√ÉO
==============================================================================


----------------------------------------------
PASSO 1: ALTERAR O WEBHOOK CALENDAR-CREATOR
----------------------------------------------

O que fazer: Remover o node "Get many rows1" do fluxo do webhook.

ANTES (fluxo atual):
  Webhook ‚Üí Edit Fields ‚Üí SET user_id ‚Üí buscar_conexao ‚Üí Edit Fields
  ‚Üí [Get many rows1] ‚Üí If (tem token?) ‚Üí criar evento

DEPOIS (fluxo novo):
  Webhook ‚Üí Edit Fields ‚Üí SET user_id ‚Üí buscar_conexao ‚Üí Edit Fields
  ‚Üí If (tem token?) ‚Üí criar evento

Como fazer:
  a) Abra o workflow "Calendar-Creator" no n8n
  b) Delete o node "Get many rows1"
  c) Conecte a sa√≠da do "Edit Fields" direto no node "If"
  d) Salve e ative

IMPORTANTE: O node "sucesso_google" e "sucesso_padrao" agora retornam
campos extras (evento_id_criado, start, end, summary). Atualize esses
nodes conforme o JSON em fix-conflito-horario-workflow.json.


----------------------------------------------
PASSO 2: ATUALIZAR RESPOSTAS DO WEBHOOK
----------------------------------------------

Os nodes "sucesso_google" e "sucesso_padrao" precisam retornar o ID do
evento criado no Supabase. Isso permite que o workflow principal saiba
quais IDs excluir da verifica√ß√£o de conflito.

No node "sucesso_google", adicione:
  - evento_id_criado = {{ $('create_calendar_sup_google').item.json.id }}
  - start = {{ $('SET user_id (debug)').item.json.start }}
  - end = {{ $('SET user_id (debug)').item.json.end }}
  - summary = {{ $('SET user_id (debug)').item.json.summary }}

No node "sucesso_padrao", adicione:
  - evento_id_criado = {{ $('create_calendar_sup_google1').item.json.id }}
  - start = {{ $('SET user_id (debug)').item.json.start }}
  - end = {{ $('SET user_id (debug)').item.json.end }}
  - summary = {{ $('SET user_id (debug)').item.json.summary }}


----------------------------------------------
PASSO 3: ADICIONAR NODES NO WORKFLOW PRINCIPAL
----------------------------------------------

Importe o arquivo fix-conflito-horario-nodes-principais.json.
Os nodes novos s√£o:

  A) PATH EVENTO √öNICO (sa√≠da TRUE do If7):

     Fluxo anterior:
       Redis2 ‚Üí HTTP Create Calendar Tool2 ‚Üí HTTP Request (template WA)

     Fluxo novo:
       Redis2 ‚Üí HTTP Create Calendar Tool2
       ‚Üí [NOVO] "Verificar Conflitos (√önico)"
       ‚Üí [NOVO] "Tem Conflito? (√önico)"
         ‚îú‚îÄ TRUE  ‚Üí HTTP Request (template WA) ‚Üí "Aviso Conflito (√önico)"
         ‚îî‚îÄ FALSE ‚Üí HTTP Request (template WA)

     O node "Verificar Conflitos (√önico)" √© um Code node que:
       1. Pega o start/end do evento rec√©m-criado
       2. Consulta Supabase: eventos sobrepostos do mesmo user
       3. Remove o pr√≥prio evento da lista (por ID)
       4. Se sobrar algo ‚Üí tem conflito real

  B) PATH M√öLTIPLOS EVENTOS (sa√≠da FALSE do If7):

     Fluxo anterior:
       HTTP Create Calendar Tool1 ‚Üí Aggregate ‚Üí lastGet6 ‚Üí If6
       ‚Üí Redis7 ‚Üí Send message2

     Fluxo novo:
       HTTP Create Calendar Tool1 ‚Üí Aggregate ‚Üí lastGet6 ‚Üí If6
       ‚Üí Redis7
       ‚Üí [NOVO] "Verificar Conflitos (Batch)"
       ‚Üí [NOVO] "Tem Conflito? (Batch)"
         ‚îú‚îÄ TRUE  ‚Üí "Aviso Conflito (Batch)" ‚Üí Send message2
         ‚îî‚îÄ FALSE ‚Üí "Sem Conflito (Batch)" ‚Üí Send message2

     O node "Verificar Conflitos (Batch)" √© um Code node que:
       1. Itera sobre TODOS os eventos do batch (toolArray)
       2. Para cada um, consulta Supabase por sobreposi√ß√µes
       3. Remove TODOS os IDs do batch da lista de conflitos
       4. Monta UMA √öNICA mensagem consolidada com todos os conflitos


----------------------------------------------
PASSO 4: CONFIGURAR CREDENCIAIS DO SUPABASE
----------------------------------------------

IMPORTANTE: Os Code nodes "Verificar Conflitos" fazem chamadas HTTP
diretamente ao Supabase. Voc√™ precisa substituir os headers placeholder
pelos seus tokens reais.

Nos dois Code nodes, localize estas linhas:
  headers: {
    'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9',
    'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9'
  }

Substitua por seu anon key real do Supabase (ou service_role key):
  headers: {
    'apikey': 'SUA_SUPABASE_ANON_KEY_AQUI',
    'Authorization': 'Bearer SUA_SUPABASE_ANON_KEY_AQUI'
  }

ALTERNATIVA (melhor): Use o node Supabase nativo do n8n em vez do
httpRequest dentro do Code. Nesse caso, separe a l√≥gica:
  1. Code node: prepara os par√¢metros de query
  2. Supabase node: executa a query
  3. Code node: processa resultados e monta mensagem


----------------------------------------------
PASSO 5: TESTAR
----------------------------------------------

Teste 1 - Evento √∫nico SEM conflito:
  ‚Üí Crie "Reuni√£o √†s 10h" quando n√£o h√° nada √†s 10h
  ‚Üí Esperado: recebe template de confirma√ß√£o, SEM aviso de conflito

Teste 2 - Evento √∫nico COM conflito:
  ‚Üí Crie "Reuni√£o √†s 10h" quando J√Å tem evento √†s 10h
  ‚Üí Esperado: recebe template + UMA mensagem de aviso

Teste 3 - M√∫ltiplos eventos SEM conflito:
  ‚Üí Crie "Reuni√£o 10h, Almo√ßo 12h, Consulta 15h"
  ‚Üí Esperado: eventos criados, SEM aviso (conflitos entre batch ignorados)

Teste 4 - M√∫ltiplos eventos COM conflito pr√©-existente:
  ‚Üí J√° existe "Dentista √†s 15h"
  ‚Üí Crie "Reuni√£o 10h, Almo√ßo 12h, Consulta 15h"
  ‚Üí Esperado: UMA mensagem dizendo que "Consulta" conflita com "Dentista"

Teste 5 - M√∫ltiplos eventos no mesmo hor√°rio:
  ‚Üí Crie "Evento A √†s 14h, Evento B √†s 14h, Evento C √†s 14h"
  ‚Üí Esperado: eventos criados normalmente, SEM aviso
    (s√£o do mesmo batch, o usu√°rio pediu explicitamente)


==============================================================================
NOTAS T√âCNICAS
==============================================================================

1. QUERY DE SOBREPOSI√á√ÉO:
   A l√≥gica de overlap √©: start_event < END_novo AND end_event > START_novo
   Isso captura qualquer evento que se sobreponha parcial ou totalmente.

2. EXCLUS√ÉO DO BATCH:
   Os IDs dos eventos criados no batch s√£o coletados a partir do retorno
   do webhook (campo evento_id_criado). Todos s√£o exclu√≠dos da query de
   conflito via filter: !idsCriados.includes(String(e.id))

3. MENSAGEM CONSOLIDADA:
   Em vez de N mensagens separadas, o sistema monta UMA mensagem como:

   ‚ö†Ô∏è Aten√ß√£o! Alguns dos seus novos eventos coincidem com eventos
   j√° existentes:

   üìå "Consulta" conflita com:
     - Dentista

   Verifique sua agenda para evitar sobreposi√ß√µes.

4. DEBOUNCE PRESERVADO:
   O mecanismo de debounce com Redis (firstGet/lastGet) continua
   funcionando normalmente. A verifica√ß√£o de conflito acontece AP√ìS
   o debounce confirmar que o batch terminou.

5. WEBHOOK SEM SIDE EFFECTS:
   O webhook agora √© "puro" - apenas cria o evento e retorna o resultado.
   N√£o envia mensagens de aviso nem faz verifica√ß√µes extras.
